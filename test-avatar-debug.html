<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Avatar System</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .result { margin: 10px 0; padding: 10px; border-radius: 5px; background: #f0f0f0; }
        .success { background-color: #d4edda; }
        .error { background-color: #f8d7da; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .avatar-test { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; margin: 10px; border: 2px solid #ccc; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Debug do Sistema de Avatar</h1>
    
    <div class="test-section">
        <h2>1. Testar Login e Dados do Usuário</h2>
        <button onclick="testLogin()">Login Demo</button>
        <button onclick="getCurrentUser()">Ver Usuário Atual</button>
        <div id="user-info"></div>
    </div>

    <div class="test-section">
        <h2>2. Testar URLs de Avatar</h2>
        <p>Teste diferentes tipos de URL para ver como o sistema responde:</p>
        
        <h3>URL Completa (HTTP):</h3>
        <img src="https://cdn.builder.io/api/v1/image/assets%2F4339d2c6c4aa4bf4b61f03263843eb86%2F477cc7711bf64b4d94e766b55d18ca30?format=webp&width=800" 
             class="avatar-test" alt="Avatar HTTP">
        <button onclick="testAvatarUpdate('https://cdn.builder.io/api/v1/image/assets%2F4339d2c6c4aa4bf4b61f03263843eb86%2F477cc7711bf64b4d94e766b55d18ca30?format=webp&width=800')">
            Definir URL Completa
        </button>

        <h3>URL Relativa (Upload):</h3>
        <img src="/placeholder.svg" class="avatar-test" alt="Avatar Relativo" id="relative-test">
        <button onclick="testAvatarUpdate('/placeholder.svg')">Definir URL Relativa</button>

        <h3>Resultado do Teste de Lógica:</h3>
        <div id="logic-test"></div>
        <button onclick="testAvatarLogic()">Testar Lógica de Avatar</button>
    </div>

    <div class="test-section">
        <h2>3. Log de Operações</h2>
        <div id="log"></div>
        <button onclick="clearLog()">Limpar Log</button>
    </div>

    <script>
        let authToken = null;
        let currentUser = null;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logDiv.innerHTML += `<div class="result ${className}">[${time}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function testLogin() {
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'demo@exemplo.com',
                        password: '123456',
                        captcha: 'test'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.token;
                    currentUser = data.user;
                    log('Login realizado com sucesso', 'success');
                    log('Token: ' + authToken.substring(0, 10) + '...');
                    log('Avatar atual: ' + currentUser.avatar);
                    updateUserInfo();
                } else {
                    const error = await response.json();
                    log('Erro no login: ' + error.message, 'error');
                }
            } catch (error) {
                log('Erro na requisição: ' + error.message, 'error');
            }
        }

        async function getCurrentUser() {
            if (!authToken) {
                log('Token não disponível. Faça login primeiro.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/auth/me', {
                    headers: { Authorization: `Bearer ${authToken}` }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    log('Dados atuais do usuário obtidos', 'success');
                    log('Avatar: ' + currentUser.avatar);
                    updateUserInfo();
                } else {
                    log('Erro ao buscar usuário', 'error');
                }
            } catch (error) {
                log('Erro na requisição: ' + error.message, 'error');
            }
        }

        function updateUserInfo() {
            const userInfoDiv = document.getElementById('user-info');
            if (currentUser) {
                userInfoDiv.innerHTML = `
                    <div class="result">
                        <strong>Nome:</strong> ${currentUser.name}<br>
                        <strong>Email:</strong> ${currentUser.email}<br>
                        <strong>Avatar:</strong> ${currentUser.avatar || 'N/A'}<br>
                        <strong>Avatar Preview:</strong><br>
                        <img src="${currentUser.avatar || ''}" class="avatar-test" 
                             onerror="this.style.display='none'" 
                             onload="this.style.display='block'"
                             alt="Avatar atual">
                    </div>
                `;
            }
        }

        async function testAvatarUpdate(avatarUrl) {
            if (!authToken) {
                log('Token não disponível. Faça login primeiro.', 'error');
                return;
            }

            try {
                log('Atualizando avatar para: ' + avatarUrl);

                const response = await fetch('/api/user/avatar', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ avatarUrl })
                });

                if (response.ok) {
                    const result = await response.json();
                    log('Avatar atualizado com sucesso!', 'success');
                    log('Novo avatar: ' + result.user.avatar);
                    currentUser = result.user;
                    updateUserInfo();
                } else {
                    const error = await response.json();
                    log('Erro ao atualizar avatar: ' + error.message, 'error');
                }
            } catch (error) {
                log('Erro na requisição: ' + error.message, 'error');
            }
        }

        function testAvatarLogic() {
            const testCases = [
                { avatar: 'https://example.com/avatar.jpg', expected: 'URL completa válida' },
                { avatar: '/uploads/avatar.jpg', expected: 'URL relativa válida' },
                { avatar: 'ABC', expected: 'Iniciais' },
                { avatar: '', expected: 'Iniciais' },
                { avatar: null, expected: 'Iniciais' }
            ];

            let results = '<h4>Teste da Lógica de Avatar:</h4>';
            
            testCases.forEach(testCase => {
                const shouldShowImage = testCase.avatar && 
                    (testCase.avatar.startsWith('http') || testCase.avatar.startsWith('/'));
                
                results += `<div class="result">
                    <strong>Input:</strong> ${testCase.avatar || 'null'}<br>
                    <strong>Deve mostrar imagem:</strong> ${shouldShowImage ? 'Sim' : 'Não'}<br>
                    <strong>Esperado:</strong> ${testCase.expected}
                </div>`;
            });

            document.getElementById('logic-test').innerHTML = results;
        }

        // Auto-load on page load
        window.onload = function() {
            log('Página carregada. Clique em "Login Demo" para começar.');
        };
    </script>
</body>
</html>
